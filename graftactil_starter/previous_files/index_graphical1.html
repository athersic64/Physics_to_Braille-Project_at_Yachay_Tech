<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GrafTactil — Editor gráfico</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 18px; background:#f7f9fc; }
    .card { margin-bottom:12px; }
    .function-row { gap:10px; }
    #preview img { max-width:100%; border:1px solid #ddd; background:#fff; padding:6px; }
    .small-muted { font-size:0.85rem; color:#6c757d; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">GrafTactil — Editor gráfico</h1>

    <div class="card p-3">
      <h5>Configuración general</h5>
      <div class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Tamaño placa (mm)</label>
          <div class="input-group">
            <input id="fig_w" type="number" class="form-control" value="173" min="10">
            <input id="fig_h" type="number" class="form-control" value="113" min="10">
          </div>
          <div class="small-muted">Ancho × Alto</div>
        </div>
        <div class="col-md-2">
          <label class="form-label">DPI</label>
          <input id="dpi" class="form-control" type="number" value="96">
        </div>
        <div class="col-md-2">
          <label class="form-label">Grosor placa (mm)</label>
          <input id="plate_thickness_mm" class="form-control" type="number" step="0.1" value="0.8">
        </div>
        <div class="col-md-2">
          <label class="form-label">Altura marcador (mm)</label>
          <input id="marker_height_mm" class="form-control" type="number" step="0.1" value="0.8">
        </div>
        <div class="col-md-3">
          <label class="form-label">Export filename</label>
          <input id="output_filename" class="form-control" type="text" value="grafica_export.stl">
        </div>
      </div>
      <div class="form-check form-switch mt-2">
        <input class="form-check-input" type="checkbox" id="only_markers" checked>
        <label class="form-check-label" for="only_markers">Solo marcadores (ocultar curvas)</label>
      </div>
    </div>

    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Funciones (marcadores)</h5>
        <div>
          <button id="addFn" class="btn btn-sm btn-primary">Agregar función</button>
        </div>
      </div>

      <div id="functionsList" class="mt-3"></div>
      <template id="fnTemplate">
        <div class="row align-items-end function-row">
          <div class="col-md-4">
            <label class="form-label">Expresión (x)</label>
            <input class="form-control fn-expr" placeholder="ej: x, x**2, sin(x)" value="x">
            <div class="small-muted">Usa funciones estándar: sin, cos, exp, log, etc.</div>
          </div>
          <div class="col-md-2">
            <label class="form-label">Marcadores (N)</label>
            <input class="form-control fn-density" type="number" value="20" min="0">
            <div class="small-muted">Número total de marcadores uniformes</div>
          </div>
          <div class="col-md-2">
            <label class="form-label">Forma</label>
            <select class="form-select fn-shape">
              <option value="o" selected>Círculo</option>
              <option value="s">Cuadrado</option>
              <option value="^">Triángulo</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Tamaño (mm)</label>
            <input class="form-control fn-size" type="number" step="0.1" value="3.0" min="0.5">
          </div>
          <div class="col-md-1">
            <button class="btn btn-danger remove-fn">Eliminar</button>
          </div>
        </div>
      </template>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="previewBtn" class="btn btn-success">Previsualizar / Generar</button>
      <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
      <div id="status" class="align-self-center small-muted"></div>
    </div>

    <div id="preview" class="mt-3"></div>
    <div id="rawJson" style="display:none;"></div>
  </div>

<script>
  // Utils y comportamiento UI
  const functionsList = document.getElementById('functionsList');
  const template = document.getElementById('fnTemplate');

  function addFunctionRow(expr='x', density=20, shape='o', size=3.0) {
    const node = document.createElement('div');
    node.className = 'card p-3 mt-2';
    node.innerHTML = template.innerHTML;
    const inputExpr = node.querySelector('.fn-expr');
    const inputDen = node.querySelector('.fn-density');
    const inputShape = node.querySelector('.fn-shape');
    const inputSize = node.querySelector('.fn-size');
    inputExpr.value = expr;
    inputDen.value = density;
    inputShape.value = shape;
    inputSize.value = size;
    node.querySelector('.remove-fn').onclick = () => node.remove();
    functionsList.appendChild(node);
  }

  function resetDefaults() {
    functionsList.innerHTML = '';
    addFunctionRow('x', 20, 'o', 3.0);
    addFunctionRow('x**2', 7, 's', 3.0);
    addFunctionRow('x**3', 6, '^', 3.5);
  }

  document.getElementById('addFn').onclick = () => addFunctionRow();
  document.getElementById('resetBtn').onclick = () => { resetDefaults(); document.getElementById('status').textContent=''; document.getElementById('preview').innerHTML=''; };

  // Construir JSON simple para backend. Usamos auto_limits=true y segment único [x0,x1] con densidad N.
  function buildConfig() {
    const funcs = [];
    const shapes = [];
    const sizes = [];
    const densities = [];
    const segments = [];
    // Tomamos limits automáticos (backend calculará)
    const only_markers = document.getElementById('only_markers').checked;
    for (const card of functionsList.children) {
      const expr = card.querySelector('.fn-expr').value.trim() || 'x';
      const den = parseInt(card.querySelector('.fn-density').value) || 0;
      const shape = card.querySelector('.fn-shape').value;
      const size = parseFloat(card.querySelector('.fn-size').value) || 3.0;
      funcs.push(expr);
      shapes.push(shape);
      sizes.push(size);
      densities.push([den]);              // un segmento
      // usaremos segmento placeholder; backend con auto_limits ignorará valores de segmento si calcula límites,
      // pero para seguridad ponemos [-5.5,5.5] como rango por defecto; backend mapeará a la placa
      segments.push([[-5.5, 5.5]]);
    }

    return {
      functions: funcs,
      labels: funcs.map(f=>f),
      curve_styles: funcs.map(()=>'-'),
      curve_linewidths: funcs.map(()=>1.0),
      marker_shapes: shapes,
      marker_sizes: sizes,
      marker_segments: segments,
      marker_densities: densities,
      fig_size_mm: [ parseFloat(document.getElementById('fig_w').value), parseFloat(document.getElementById('fig_h').value) ],
      dpi: parseInt(document.getElementById('dpi').value) || 96,
      auto_limits: true,
      step_mm: 7.45,
      tick_step: 0.5,
      plate_thickness_mm: parseFloat(document.getElementById('plate_thickness_mm').value) || 0.8,
      marker_height_mm: parseFloat(document.getElementById('marker_height_mm').value) || 0.8,
      output_filename: document.getElementById('output_filename').value || 'grafica_export.stl',
      only_markers: only_markers,
      mm_per_inch: 23.4555555,
      save_pdf: false
    };
  }

  async function doGenerate() {
    const status = document.getElementById('status');
    status.textContent = 'Generando...';
    const cfg = buildConfig();
    try {
      const resp = await fetch('/generate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(cfg)
      });
      const json = await resp.json();
      if (!resp.ok) {
        status.textContent = 'Error: ' + (json.error || JSON.stringify(json));
        return;
      }
      status.textContent = 'Export iniciado.';
      const out = document.getElementById('preview');
      out.innerHTML = '';
      if (json.preview_svg) {
        out.innerHTML += `<div class="card p-3"><h6>Previsualización</h6><img src="${json.preview_svg}" alt="preview"></div>`;
      }
      if (json.stl) {
        out.innerHTML += `<div class="card p-3 mt-2"><h6>Descarga</h6><a class="btn btn-primary" href="${json.stl}" target="_blank">Descargar STL</a><p class="small-muted mt-2">Si el STL aún no está listo espera unos segundos y recarga el enlace.</p></div>`;
      }
      // escribir el JSON en un contenedor oculto
      document.getElementById('rawJson').textContent = JSON.stringify(json, null, 2);
    } catch (err) {
      status.textContent = 'Error de conexión: ' + err.message;
    }
  }

  document.getElementById('previewBtn').onclick = doGenerate;

  // Inicializar
  resetDefaults();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>